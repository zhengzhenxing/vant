import{c as te,u as de,f as ne,l as oe,D as U,e as ae,b as he,E as ge}from"./use-translate.8b8ccbb1.js";import{d as _,u as ve,a as xe,n as q,b as le,c as p,m as be,t as Ce}from"./with-install.994557f3.js";import{H as G,a as Te}from"./constant.80c6de18.js";import{u as se}from"./use-expose.6f045672.js";import{L as ye}from"./index.4ba0b313.js";import{d as Q}from"./deep-clone.a2aa4b8a.js";import{u as Ie}from"./use-touch.b6ff7b52.js";import{z as ie,D as z,H as we,x as J,e as r,C as W}from"./vue-libs.bf80eadf.js";const X=200,Z=300,Oe=15,[ce,Y]=te("picker-column");function ke(t){const{transform:x}=window.getComputedStyle(t),i=x.slice(7,x.length-1).split(", ")[5];return Number(i)}const ue=Symbol(ce),F=t=>ne(t)&&t.disabled;var He=ie({name:ce,props:{textKey:_(String),readonly:Boolean,allowHtml:Boolean,className:ve,itemHeight:_(Number),defaultIndex:xe(0),swipeDuration:_(q),initialOptions:le(),visibleItemCount:_(q)},emits:["change"],setup(t,{emit:x,slots:i}){let d,h,O,g,c;const T=z(),a=we({index:t.defaultIndex,offset:0,duration:0,options:Q(t.initialOptions)}),b=Ie(),m=()=>a.options.length,P=()=>t.itemHeight*(+t.visibleItemCount-1)/2,$=o=>{o=U(o,0,m());for(let l=o;l<m();l++)if(!F(a.options[l]))return l;for(let l=o-1;l>=0;l--)if(!F(a.options[l]))return l},f=(o,l)=>{o=$(o)||0;const u=-o*t.itemHeight,v=()=>{o!==a.index&&(a.index=o,l&&x("change",o))};d&&u!==a.offset?c=v:v(),a.offset=u},N=o=>{JSON.stringify(o)!==JSON.stringify(a.options)&&(a.options=Q(o),f(t.defaultIndex))},S=o=>{d||t.readonly||(c=null,a.duration=X,f(o,!0))},y=o=>ne(o)&&t.textKey in o?o[t.textKey]:o,k=o=>U(Math.round(-o/t.itemHeight),0,m()-1),D=(o,l)=>{const u=Math.abs(o/l);o=a.offset+u/.003*(o<0?-1:1);const v=k(o);a.duration=+t.swipeDuration,f(v,!0)},H=()=>{d=!1,a.duration=0,c&&(c(),c=null)},E=o=>{if(!t.readonly){if(b.start(o),d){const l=ke(T.value);a.offset=Math.min(0,l-P()),h=a.offset}else h=a.offset;a.duration=0,O=Date.now(),g=h,c=null}},A=o=>{if(t.readonly)return;b.move(o),b.isVertical()&&(d=!0,oe(o,!0)),a.offset=U(h+b.deltaY.value,-(m()*t.itemHeight),t.itemHeight);const l=Date.now();l-O>Z&&(O=l,g=a.offset)},M=()=>{if(t.readonly)return;const o=a.offset-g,l=Date.now()-O;if(l<Z&&Math.abs(o)>Oe){D(o,l);return}const v=k(a.offset);a.duration=X,f(v,!0),setTimeout(()=>{d=!1},0)},L=()=>{const o={height:`${t.itemHeight}px`};return a.options.map((l,u)=>{const v=y(l),V=F(l),R={role:"button",style:o,tabindex:V?-1:0,class:Y("item",{disabled:V,selected:u===a.index}),onClick:()=>S(u)},K={class:"van-ellipsis",[t.allowHtml?"innerHTML":"textContent"]:v};return r("li",R,[i.option?i.option(l):r("div",K,null)])})},j=o=>{const{options:l}=a;for(let u=0;u<l.length;u++)if(y(l[u])===o)return f(u)},B=()=>a.options[a.index];return f(a.index),de(ue),se({state:a,setIndex:f,getValue:B,setValue:j,setOptions:N,stopMomentum:H}),J(()=>t.initialOptions,N),J(()=>t.defaultIndex,o=>f(o)),()=>r("div",{class:[Y(),t.className],onTouchstart:E,onTouchmove:A,onTouchend:M,onTouchcancel:M},[r("ul",{ref:T,style:{transform:`translate3d(0, ${a.offset+P()}px, 0)`,transitionDuration:`${a.duration}ms`,transitionProperty:a.duration?"all":"none"},class:Y("wrapper"),onTransitionend:H},[L()])])}});const[Me,C,ee]=te("picker"),Ne={title:String,loading:Boolean,readonly:Boolean,allowHtml:Boolean,itemHeight:p(44),showToolbar:Ce,swipeDuration:p(1e3),visibleItemCount:p(6),cancelButtonText:String,confirmButtonText:String},Se=ae({},Ne,{columns:le(),valueKey:String,defaultIndex:p(0),toolbarPosition:be("top"),columnsFieldNames:Object});var $e=ie({name:Me,props:Se,emits:["confirm","cancel","change"],setup(t,{emit:x,slots:i}){const d=z(!1),h=z([]),{text:O,values:g,children:c}=ae({text:t.valueKey||"text",values:"values",children:"children"},t.columnsFieldNames),{children:T,linkChildren:a}=he(ue);a();const b=W(()=>ge(t.itemHeight)),m=W(()=>{const e=t.columns[0];if(typeof e=="object"){if(c in e)return"cascade";if(g in e)return"object"}return"plain"}),P=()=>{var s;const e=[];let n={[c]:t.columns};for(;n&&n[c];){const I=n[c];let w=(s=n.defaultIndex)!=null?s:+t.defaultIndex;for(;I[w]&&I[w].disabled;)if(w<I.length-1)w++;else{w=0;break}e.push({[g]:n[c],className:n.className,defaultIndex:w}),n=I[w]}h.value=e},$=()=>{const{columns:e}=t;m.value==="plain"?h.value=[{[g]:e}]:m.value==="cascade"?P():h.value=e,d.value=h.value.some(n=>n[g]&&n[g].length!==0)},f=()=>T.map(e=>e.state.index),N=(e,n)=>{const s=T[e];s&&(s.setOptions(n),d.value=!0)},S=e=>{let n={[c]:t.columns};const s=f();for(let I=0;I<=e;I++)n=n[c][s[I]];for(;n&&n[c];)e++,N(e,n[c]),n=n[c][n.defaultIndex||0]},y=e=>T[e],k=e=>{const n=y(e);if(n)return n.getValue()},D=(e,n)=>{const s=y(e);s&&(s.setValue(n),m.value==="cascade"&&S(e))},H=e=>{const n=y(e);if(n)return n.state.index},E=(e,n)=>{const s=y(e);s&&(s.setIndex(n),m.value==="cascade"&&S(e))},A=e=>{const n=y(e);if(n)return n.state.options},M=()=>T.map(e=>e.getValue()),L=e=>{e.forEach((n,s)=>{D(s,n)})},j=e=>{e.forEach((n,s)=>{E(s,n)})},B=e=>{m.value==="plain"?x(e,k(0),H(0)):x(e,M(),f())},o=e=>{m.value==="cascade"&&S(e),m.value==="plain"?x("change",k(0),H(0)):x("change",M(),e)},l=()=>{T.forEach(e=>e.stopMomentum()),B("confirm")},u=()=>B("cancel"),v=()=>{if(i.title)return i.title();if(t.title)return r("div",{class:[C("title"),"van-ellipsis"]},[t.title])},V=()=>{const e=t.cancelButtonText||ee("cancel");return r("button",{type:"button",class:[C("cancel"),G],onClick:u},[i.cancel?i.cancel():e])},R=()=>{const e=t.confirmButtonText||ee("confirm");return r("button",{type:"button",class:[C("confirm"),G],onClick:l},[i.confirm?i.confirm():e])},K=()=>{if(t.showToolbar){const e=i.toolbar||i.default;return r("div",{class:C("toolbar")},[e?e():[V(),v(),R()]])}},re=()=>h.value.map((e,n)=>{var s;return r(He,{textKey:O,readonly:t.readonly,allowHtml:t.allowHtml,className:e.className,itemHeight:b.value,defaultIndex:(s=e.defaultIndex)!=null?s:+t.defaultIndex,swipeDuration:t.swipeDuration,initialOptions:e[g],visibleItemCount:t.visibleItemCount,onChange:()=>o(n)},{option:i.option})}),me=e=>{if(d.value){const n={height:`${b.value}px`},s={backgroundSize:`100% ${(e-b.value)/2}px`};return[r("div",{class:C("mask"),style:s},null),r("div",{class:[Te,C("frame")],style:n},null)]}},fe=()=>{const e=b.value*+t.visibleItemCount,n={height:`${e}px`};return r("div",{class:C("columns"),style:n,onTouchmove:oe},[re(),me(e)])};return J(()=>t.columns,$,{immediate:!0}),se({confirm:l,getValues:M,setValues:L,getIndexes:f,setIndexes:j,getColumnIndex:H,setColumnIndex:E,getColumnValue:k,setColumnValue:D,getColumnValues:A,setColumnValues:N}),()=>{var e,n;return r("div",{class:C()},[t.toolbarPosition==="top"?K():null,t.loading?r(ye,{class:C("loading")},null):null,(e=i["columns-top"])==null?void 0:e.call(i),fe(),(n=i["columns-bottom"])==null?void 0:n.call(i),t.toolbarPosition==="bottom"?K():null])}}});export{$e as _,Ne as p};
